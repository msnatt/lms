function leaveMeet() {
    console.log("leave meet.");

    if (currentRoomId !== 0) {
        console.log(`Sending leave message for room: ${currentRoomId} and user: ${currentUserId}`);
        socket.send(JSON.stringify({
            type: "leave",
            room_id: currentRoomId,
            user_id: currentUserId
        }));
    }

    // à¸›à¸´à¸”à¹à¸¥à¸°à¸¥à¸š peerConnections à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
    for (let id in peerConnections) {
        if (peerConnections[id]) {
            console.log(`Closing peer connection for user: ${id}`);
            peerConnections[id].close();
        }
    }
    peerConnections = {};

    // à¸«à¸¢à¸¸à¸” local stream à¹à¸¥à¸°à¸›à¸´à¸”à¸à¸¥à¹‰à¸­à¸‡/à¹„à¸¡à¸„à¹Œ
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
        console.log("Local stream stopped.");
    }

    // à¸¥à¹‰à¸²à¸‡à¸§à¸´à¸”à¸µà¹‚à¸­ local
    const localVideo = document.getElementById("localVideo");
    if (localVideo) localVideo.srcObject = null;

    // à¸¥à¹‰à¸²à¸‡à¸§à¸´à¸”à¸µà¹‚à¸­ remote à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”
    const remoteVideosContainer = document.getElementById("remoteVideosContainer");
    if (remoteVideosContainer) {
        remoteVideosContainer.innerHTML = "";
    }

    console.log("âœ… All peer connections closed and video streams cleared.");
}

async function selectRoomChat(roomId, roomName) {
    console.log(`Attempting to select room: ${roomId} (${roomName})`);
    if (roomId !== currentRoomId) {

        if (Object.keys(peerConnections).length > 0) {
            console.log("There are active peer connections, leaving the meeting...");
            leaveMeet();
        }

        const chatHeader = document.getElementById("chat-header");
        const chatBox = document.getElementById("chat-box");
        const meetbox = document.getElementById("meet-box");
        meetbox.style.display = 'block';

        // 1. à¸­à¸±à¸›à¹€à¸”à¸•à¸«à¸±à¸§à¸‚à¹‰à¸­à¸«à¹‰à¸­à¸‡
        chatHeader.innerText = `${roomName}`;

        // à¸à¸³à¸«à¸™à¸”à¸«à¹‰à¸­à¸‡à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™à¹ƒà¸«à¸¡à¹ˆ à¸ˆà¸²à¸ div à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸
        currentRoomId = roomId;
        console.log(`Joining room ${currentRoomId} for user: ${currentUserId}`);
        socket.send(JSON.stringify({
            type: "join",
            room_id: currentRoomId,
            user_id: currentUserId
        }));
        // à¹‚à¸«à¸¥à¸”à¹à¸Šà¸—à¸‚à¸­à¸‡à¸«à¹‰à¸­à¸‡à¹à¸Šà¸—à¹ƒà¸«à¸¡à¹ˆ
        await loadChat(roomId, roomName);
    }
};

async function Confirm_connect(camSelect, micSelect) {
    console.log("Confirming connection with selected camera and microphone.");
    if (Object.keys(peerConnections).length > 0) {
        console.log("Closing active peer connections before confirming.");
        leaveMeet();
    }

    toggleSettingPanel();
    const stream = await startVideo(camSelect.value, micSelect.value);
    if (stream) {
        console.log("Starting video with selected devices.");
        // createOffer(); // à¸«à¸£à¸·à¸­à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸­à¸·à¹ˆà¸™ à¹†
    }
}

async function startVideo(deviceId, audioId) {
    console.log(`Starting video with deviceId: ${deviceId}, audioId: ${audioId}`);
    try {
        let stream;

        try {
            // à¸žà¸¢à¸²à¸¢à¸²à¸¡à¸‚à¸­ video + audio stream
            stream = await navigator.mediaDevices.getUserMedia({
                video: deviceId ? { deviceId: { exact: deviceId } } : true,
                audio: audioId ? { deviceId: { exact: audioId } } : true,
            });
            console.log("âœ… Got video+audio stream", stream);
        } catch (err) {
            console.warn("âš ï¸ Failed to get audio, trying video only...", err);

            // à¸–à¹‰à¸² audio error, fallback à¸‚à¸­ video à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸”à¸µà¸¢à¸§
            stream = await navigator.mediaDevices.getUserMedia({
                video: deviceId ? { deviceId: { exact: deviceId } } : true,
            });
            console.log("âœ… Got video stream only", stream);
        }

        // à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² video preview à¹à¸¥à¸°à¹€à¸à¹‡à¸š stream
        const localVideo = document.getElementById("localVideo");
        if (localVideo) localVideo.srcObject = stream;
        localStream = stream;

        return stream;

    } catch (error) {
        console.error("âŒ Cannot access media devices:", error);
        return null;
    }
}

socket.onopen = function () {
    console.log("Connected to WebSocket");
};

socket.onmessage = async function (event) {
    console.log("Received message from WebSocket:", event.data);
    const data = JSON.parse(event.data);
    const fromId = data.from_user_id;
    switch (data.type) {
        case "join":
        case "leave":
        case "chat":
            handleTextMessage(data);
            break;
        case "offer":
            console.log(`Handling offer from user ${fromId}`);
            await handleOffer(data.offer, data.from_user_id);
            break;
        case "answer":
            console.log(`Handling answer from user ${fromId}`);
            await handleAnswer(data.answer, data.from_user_id);
            break;
        case "candidate":
            console.log(`Handling candidate from user ${fromId}`);
            await handleCandidate(data.candidate);
            break;
        case "new-peer":
            console.log(`Handling new peer connection for user ${data.new_user_id}`);
            await createOfferTo(data.new_user_id);
            break;
        default:
            console.warn("Unknown message type:", data.type);
    }
};

async function handleOffer(offer, fromId) {
    console.log(`ðŸ“¨ Received offer from: ${fromId}`);
    await createPeerConnection(fromId);
    await peerConnections[fromId].setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await peerConnections[fromId].createAnswer();
    await peerConnections[fromId].setLocalDescription(answer);
    socket.send(JSON.stringify({
        type: "answer",
        answer,
        room_id: currentRoomId,
        from_user_id: currentUserId,
        target_id: fromId
    }));
}

async function handleAnswer(answer, fromId) {
    console.log(`ðŸ“¨ Received answer from: ${fromId}`);
    if (peerConnections[fromId]) {
        await peerConnections[fromId].setRemoteDescription(new RTCSessionDescription(answer));
    }
}

async function handleCandidate(candidate, fromId) {
    console.log(`ðŸ“¨ Received candidate from: ${fromId}`);
    if (peerConnections[fromId]) {
        await peerConnections[fromId].addIceCandidate(new RTCIceCandidate(candidate));
    }
}

function createPeerConnection(targetId) {
    if (peerConnections[targetId]) return;

    console.log(`Creating new peer connection for targetId: ${targetId}`);
    const pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
    });

    peerConnections[targetId] = pc;

    pc.onicecandidate = event => {
        if (event.candidate) {
            console.log(`Sending ICE candidate to ${targetId}`);
            socket.send(JSON.stringify({
                type: "candidate",
                candidate: event.candidate,
                room_id: currentRoomId,
                from_user_id: currentUserId,
                target_id: targetId
            }));
        }
    };

    pc.ontrack = event => {
        console.log(`Received track from peer: ${targetId}`);
        let remoteVideo = document.getElementById(`remote-${targetId}`);
        if (!remoteVideo) {
            remoteVideo = document.createElement("video");
            remoteVideo.id = `remote-${targetId}`;
            remoteVideo.autoplay = true;
            remoteVideo.playsInline = true;
            document.getElementById("remoteVideosContainer").appendChild(remoteVideo);
        }
        remoteVideo.srcObject = event.streams[0];
    };

    // à¹€à¸žà¸´à¹ˆà¸¡ local track
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    return pc;
}

async function createOfferTo(targetId) {
    console.log(`Creating offer to targetId: ${targetId}`);
    await createPeerConnection(targetId);
    const offer = await peerConnections[targetId].createOffer();
    await peerConnections[targetId].setLocalDescription(offer);

    socket.send(JSON.stringify({
        type: "offer",
        offer,
        room_id: currentRoomId,
        from_user_id: currentUserId,
        target_id: targetId
    }));
}
