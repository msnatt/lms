<!-- page product -->
<script>
    let exam = null;
    let timeLimit = null;
    let startTime = null; // UNIX timestamp
    let timerInterval = null;

    document.addEventListener('DOMContentLoaded', async () => {
        const params = new URLSearchParams(window.location.search);
        const examId = params.get('exam');

        const response = await fetch(`../config/fetch_questionall.php?exam_id=${examId}`);
        exam = await response.json();
        timeLimit = exam.exam_period * 60;

        console.log(exam);

        document.getElementById('exam-title').innerText = exam.title;
        document.getElementById('exam-description').innerText = exam.description;

        // à¸–à¹‰à¸²à¸¡à¸µà¹€à¸§à¸¥à¸²à¹€à¸£à¸´à¹ˆà¸¡à¸ªà¸­à¸šà¹ƒà¸™ localStorage à¹ƒà¸«à¹‰à¹‚à¸«à¸¥à¸”à¹€à¸¥à¸¢
        const storedStart = localStorage.getItem(`exam_${examId}_start`);
        if (storedStart) {
            startTime = parseInt(storedStart);
            document.getElementById('startExamBtn').classList.add('d-none');
            document.getElementById('toggle-form').classList.replace('d-none', 'd-flex');
            document.getElementById('toggle-form').classList.add('flex-wrap');
            startExam(true); // à¹€à¸£à¸´à¹ˆà¸¡à¸ªà¸­à¸šà¹à¸šà¸šà¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸”à¸´à¸¡
        }

        // âœ… à¸šà¸±à¸™à¸—à¸¶à¸à¸„à¸³à¸•à¸­à¸šà¸—à¸±à¸™à¸—à¸µà¹€à¸¡à¸·à¹ˆà¸­à¹€à¸¥à¸·à¸­à¸
        document.addEventListener('change', function (e) {
            if (e.target.classList.contains('form-check-input')) {
                const name = e.target.name;
                const value = e.target.value;
                localStorage.setItem(`exam_${examId}_${name}`, value);
            }
        });

    });

    function startExam(restore = false) {
        const examId = new URLSearchParams(window.location.search).get('exam');

        if (!restore) {
            startTime = Math.floor(Date.now() / 1000); // timestamp à¸§à¸´à¸™à¸²à¸—à¸µ
            localStorage.setItem(`exam_${examId}_start`, startTime);
        }

        const timerDisplay = document.createElement('div');
        timerDisplay.className = "alert alert-info";
        timerDisplay.id = "timer-display";
        document.getElementById('exam-container').append(timerDisplay);

        loadExam();

        updateTimer(timerDisplay);
    }

    function loadExam() {
        const questionsList = document.getElementById('questions-list');
        const examId = new URLSearchParams(window.location.search).get('exam');
        questionsList.innerHTML = ''; // à¸¥à¹‰à¸²à¸‡à¸à¹ˆà¸­à¸™

        exam.questions.forEach((q, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = "mb-4";

            const storedAnswer = localStorage.getItem(`exam_${examId}_question_${q.questions_id}`);

            questionDiv.innerHTML = `
                <h5>${index + 1}. ${q.questions_question_text}</h5>
                ${q.choices.map(choice => `
                    <div class="form-check">
                        <input class="form-check-input" type="radio"
                            name="question_${q.questions_id}"
                            value="${choice.choices_id}"
                            ${storedAnswer == choice.choices_id ? 'checked' : ''} required>
                        <label class="form-check-label">${choice.choices_choice_text}</label>
                    </div>
                `).join('')}
            `;

            questionsList.appendChild(questionDiv);
        });
    }

    function updateTimer(timerDisplay) {
        if (timerInterval) clearInterval(timerInterval);

        timerInterval = setInterval(() => {
            const now = Math.floor(Date.now() / 1000);
            const elapsed = now - startTime;
            const remaining = timeLimit - elapsed;

            if (remaining <= 0) {
                clearInterval(timerInterval); // à¸«à¸¢à¸¸à¸”à¸à¸²à¸£à¸™à¸±à¸šà¹€à¸§à¸¥à¸²
                localStorage.removeItem(`exam_${exam.id}_start`); // ðŸ” à¸¥à¸š startTime à¸—à¸µà¹ˆà¸šà¸±à¸™à¸—à¸¶à¸à¹„à¸§à¹‰
                document.getElementById('exam-form').submit();
            } else {
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                timerDisplay.innerText = `à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¹€à¸«à¸¥à¸·à¸­: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            }
        }, 1000);
    }

    function collectAnswers() {
        const examId = new URLSearchParams(window.location.search).get('exam');
        const answers = [];

        exam.questions.forEach(q => {
            const inputName = `question_${q.questions_id}`;
            const selected = document.querySelector(`input[name="${inputName}"]:checked`);

            answers.push({
                question_id: q.questions_id,
                choice_id: selected ? selected.value : null // à¸–à¹‰à¸²à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¹€à¸¥à¸·à¸­à¸à¸ˆà¸°à¹€à¸›à¹‡à¸™ null
            });
        });

        console.log("à¸„à¸³à¸•à¸­à¸šà¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸:", answers);
        return answers;
    }
    function handleSubmit(event) {
        event.preventDefault(); // à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸à¸²à¸£ reload à¸«à¸™à¹‰à¸²

        const userAnswers = collectAnswers();

        // âœ… à¸ªà¹ˆà¸‡à¸œà¹ˆà¸²à¸™ fetch() à¹„à¸›à¸¢à¸±à¸‡ PHP
        fetch('../config/save_answer.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                exam_id: exam.id,
                answers: userAnswers
            })
        })
            .then(res => res.json())
            .then(data => {
                alert("à¸ªà¹ˆà¸‡à¸„à¸³à¸•à¸­à¸šà¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§!");
                localStorage.removeItem(`exam_${exam.id}_start`); // à¹€à¸„à¸¥à¸µà¸¢à¸£à¹Œà¹€à¸§à¸¥à¸²
                exam.questions.forEach(q => {
                    localStorage.removeItem(`exam_${exam.id}_question_${q.questions_id}`);
                });
                window.location.href = 'result.php?exam=' + exam.id;
            });

        return false;
    }
</script>