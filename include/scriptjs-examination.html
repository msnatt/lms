<!-- page product -->
<script>
    let exam = null;
    let timeLimit = null;
    let startTime = null; // UNIX timestamp
    let timerInterval = null;
    let course_id = null;
    let unit_id = null;

    document.addEventListener('DOMContentLoaded', async () => {
        const params = new URLSearchParams(window.location.search);
        const examId = params.get('exam');
        course_id = params.get('c');
        unit_id = params.get('u');

        const response = await fetch(`../config/fetch_questionall.php?exam_id=${examId}`);
        exam = await response.json();
        timeLimit = exam.exam_period * 60;

        console.log(exam);

        document.getElementById('exam-title').innerText = exam.title;
        document.getElementById('exam-description').innerText = exam.description;

        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≠‡∏ö‡πÉ‡∏ô localStorage ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏•‡∏¢
        const storedStart = localStorage.getItem(`exam_${examId}_start`);
        if (storedStart) {
            startTime = parseInt(storedStart);
            await startExam(true); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°
        }

        // ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        document.addEventListener('change', function (e) {
            if (e.target.classList.contains('form-check-input')) {
                const name = e.target.name;
                const value = e.target.value;
                localStorage.setItem(`exam_${examId}_${name}`, value);
            }
        });

    });

    async function startExam(restore = false) {
        const examId = new URLSearchParams(window.location.search).get('exam');

        if (!restore) {
            startTime = Math.floor(Date.now() / 1000); // timestamp ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            localStorage.setItem(`exam_${examId}_start`, startTime);
        }

        const timerDisplay = document.createElement('div');
        timerDisplay.className = "alert alert-info";
        timerDisplay.id = "timer-display";
        document.getElementById('exam-container').append(timerDisplay);

        await loadExam();

        updateTimer(timerDisplay);
    }

    function removelocalstorage() {
        const examId = new URLSearchParams(window.location.search).get('exam');
        if (!examId || !exam) return;

        // ‡∏•‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≠‡∏ö
        localStorage.removeItem(`exam_${examId}_start`);

        // ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
        exam.questions.forEach(q => {
            localStorage.removeItem(`exam_${examId}_question_${q.questions_id}`);
        });

        console.log(`LocalStorage ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö exam_${examId} ‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß`);

        // location.reload();
    }

    function loadExam() {
        document.getElementById('startExamBtn').classList.add('d-none');
        document.getElementById('toggle-form').classList.replace('d-none', 'd-flex');
        document.getElementById('toggle-form').classList.add('flex-wrap');
        const questionsList = document.getElementById('questions-list');
        const examId = new URLSearchParams(window.location.search).get('exam');
        questionsList.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô

        exam.questions.forEach((q, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = "mb-4";

            const storedAnswer = localStorage.getItem(`exam_${examId}_question_${q.questions_id}`);

            questionDiv.innerHTML = `
                <h5>${index + 1}. ${q.questions_question_text}</h5>
                ${q.choices.map(choice => `
                    <div class="form-check">
                        <input class="form-check-input" type="radio"
                            name="question_${q.questions_id}"
                            value="${choice.choices_id}"
                            ${storedAnswer == choice.choices_id ? 'checked' : ''} required>
                        <label class="form-check-label">${choice.choices_choice_text}</label>
                    </div>
                `).join('')}
            `;

            questionsList.appendChild(questionDiv);
        });
    }

    function updateTimer(timerDisplay) {
        if (timerInterval) clearInterval(timerInterval);

        timerInterval = setInterval(() => {
            const now = Math.floor(Date.now() / 1000);
            const elapsed = now - startTime;
            const remaining = timeLimit - elapsed;

            if (remaining <= 0) {
                clearInterval(timerInterval); // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
                localStorage.removeItem(`exam_${exam.id}_start`); // üîÅ ‡∏•‡∏ö startTime ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
                document.getElementById('exam-form').submit();
            } else {
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                timerDisplay.innerText = `‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            }
        }, 1000);
    }

    function collectAnswers() {
        const examId = new URLSearchParams(window.location.search).get('exam');
        const answers = [];

        exam.questions.forEach(q => {
            const inputName = `question_${q.questions_id}`;
            const selected = document.querySelector(`input[name="${inputName}"]:checked`);

            answers.push({
                question_id: q.questions_id,
                choice_id: selected ? selected.value : null // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô null
            });
        });

        console.log("‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å:", answers);
        return answers;
    }

    function handleSubmit(event) {
        event.preventDefault(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ reload ‡∏´‡∏ô‡πâ‡∏≤

        const userAnswers = collectAnswers();

        console.log(userAnswers);

        // ‚úÖ ‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô fetch() ‡πÑ‡∏õ‡∏¢‡∏±‡∏á PHP
        fetch('../config/exam_answers.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                exam_id: exam.id,
                answers: userAnswers
            })
        })
            .then(res => res.json())
            .then(data => {
                removelocalstorage();
                console.log(data.message);
                if (data.status === 'success') {
                    checkUserAnswer();
                } else if (data.status === 'duplicate') {
                    const message = encodeURIComponent(data.message);
                    window.location.href = `examinationed.php?t=${message}`;
                }
            });

        // return false;
    }

    function checkUserAnswer() {
        fetch('../config/exam_checkanswer.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                correct_data: exam
            })
        })
            .then(res => res.json())
            .then(data => {
                let formdata = new FormData();
                formdata.append("score_percent", data.score_percent);
                formdata.append("correct", data.correct);
                formdata.append("total", data.total);
                formdata.append("course_id", course_id);
                formdata.append("unit_id", unit_id);
                fetch('../config/exam_point.php', {
                    method: 'POST',
                    body: formdata
                })
                    .then(() => {
                        const message = encodeURIComponent("‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß.");
                        window.location.href = `examinationed.php?t=${message}`;
                    });
            });
    }
</script>