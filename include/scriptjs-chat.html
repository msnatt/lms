<script>
    // const socket = new WebSocket("wss://localhost:8085/");
    const socket = new WebSocket("wss://49.0.69.152:8085/");

    let peerConnections = {};
    let localStream = null;
    let currentRoomId = null;
    let currentUserId = "<?php echo $_SESSION['user']['id']; ?>";
    let remoteVideo = document.getElementById("remoteVideo");
    let localVideo = document.getElementById('localVideo');

    const config = {
        iceServers: [
            { urls: "stun:stun.l.google.com:19302" }
        ]
    };

    document.addEventListener("DOMContentLoaded", () => {
        loadChatRooms();
    });

    async function loadChatRooms() {
        try {
            const chatAccessRes = await fetch("../config/chat_access.php");
            const chat_access = await chatAccessRes.json();

            const res = await fetch("../config/chat-loadrooms.php");
            const data = await res.json();

            const select = document.getElementById("list-room-chat");
            const currentUserId = "<?php echo $_SESSION['user_id']; ?>"; // ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤ JS ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô .php

            for (const room of data) {
                for (const ca of chat_access) {
                    if (ca.user_id == currentUserId && ca.chat_room_id == room.id) {

                        // fetch ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                        const response_ = await fetch(`../config/chat-last.php?room_id=${room.id}`);
                        const chatroom = await response_.json();
                        const lastMessage = chatroom.message ?? "[‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°]";

                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á div ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á
                        const div = document.createElement("div");
                        div.id = "room_" + room.id;
                        div.className = "gap-1 box-chat m-1";
                        div.onclick = () => selectRoomChat(room.id, room.name);

                        // ‚úÖ ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á
                        const name = document.createElement("div");
                        name.className = "fw-bold";
                        name.innerText = room.name;

                        // ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                        const preview = document.createElement("div");
                        preview.className = "text-muted small";
                        preview.innerText = lastMessage;

                        // ‡πÉ‡∏™‡πà‡πÉ‡∏ô div ‡∏´‡∏•‡∏±‡∏Å
                        div.appendChild(name);
                        div.appendChild(preview);
                        select.appendChild(div);
                    }
                }
            }
        } catch (error) {
            console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
        }
    }

    async function toggleControl() {
        const videocallbox = document.getElementById('videocall-box');
        const infobox = document.getElementById('infomation-box');
        const commubox = document.getElementById('commu-box');
        await toggleDisplay(videocallbox, infobox);
        togglewidthVideoandChats(commubox, videocallbox);
    }

    async function toggleDisplay(Element1, Element2) {

        const meetbox = document.getElementById('meet-box');
        let toggle = Element1.style.visibility == 'hidden';
        if (toggle) {
            Element1.style.visibility = "visible";
            Element2.style.visibility = "hidden";
            Element1.style.display = "block";
            Element2.style.display = "none";
            meetbox.style.display = 'none';
            await videocall();

        } else {
            Element1.style.visibility = "hidden";
            Element2.style.visibility = "visible";
            Element1.style.display = "none";
            Element2.style.display = "block";
            meetbox.style.display = 'block';
            leaveMeet();
        }
    }

    function togglewidthVideoandChats(commubox, videocallbox) {
        let toggleclass = commubox.classList.contains('col-lg-7');
        commubox.classList.replace(toggleclass ? 'col-lg-7' : 'col-lg-3', toggleclass ? 'col-lg-3' : 'col-lg-7')
        if (videocallbox.classList.contains('col-7')) {
            videocallbox.classList.remove('col-7');
        } else {
            videocallbox.classList.add('col-7');
        }
    }

    function toggleSettingPanel() {
        const panel = document.getElementById("settingPanel");
        if (panel.style.display === "none" || panel.style.display === "") {
            panel.style.display = "flex"; // ‡∏´‡∏£‡∏∑‡∏≠ "block" ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ flex
        } else {
            panel.style.display = "none";
        }
    }

    document.getElementById('chat-message').addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            sendMessage(); // ‡∏´‡∏£‡∏∑‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        }
    });

    function displayMessage(name, message) {
        const chatBox = document.getElementById("chat-box");
        const messageDiv = document.createElement("div");
        messageDiv.innerHTML = `<b>${name}:</b> ${message}`;
        chatBox.appendChild(messageDiv);
    }

    function sendMessage() {
        const input = document.getElementById("chat-message");
        const msg = input.value;

        const message = {
            type: "chat",
            room_id: currentRoomId, // ‡πÑ‡∏≠‡∏î‡∏µ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            user_id: "<?php echo $_SESSION['user_id']; ?>",
            name: "<?php echo $_SESSION['user']['name']; ?>",
            message: input.value
        };

        if (msg.trim() !== "") {
            socket.send(JSON.stringify(message)); // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á WebSocket server
            input.value = "";
        }
    }

    async function loadChat(roomId, roomName) {

        fetch("../config/chat-load.php?room_id=" + roomId)
            .then(res => res.json())
            .then(data => {
                const chatBox = document.getElementById("chat-box");
                chatBox.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤
                data.forEach(msg => {
                    chatBox.innerHTML += `<div><strong>${msg.name}:</strong> ${msg.message}</div>`;
                });
            });

        let response = await fetch("../config/chat-users.php?roomId=" + roomId);
        let chatroom = await response.json();
        let users_access = chatroom['users'];

        let statusChat = document.getElementById("status-chat");
        statusChat.textContent = "";
        let nameChat = document.getElementById("name-chat");
        nameChat.textContent = roomName;
        users_access.forEach(user => {
            const div = document.createElement('div');
            div.className = "py-2";
            div.textContent = `${user.code} - ${user.name}`;
            // div.innerHTML = `

            // `;
            statusChat.appendChild(div);
        });

        let res = await fetch("../config/chat-users.php?roomId=" + roomId);
        let users = await res.json();
        let addmember = document.createElement('input');
        addmember.className = "form-control";
        addmember.placeholder = "Add member to chat";
        addmember.addEventListener('keyup', function (event) {
            if (event.key === 'Enter') {
                let memberName = addmember.value;
                addmember.value = '';
            }
        });
        statusChat.appendChild(addmember);
    }

    async function loadChatHistory(roomId) {
        fetch(`../config/chat-load.php?room_id=${roomId}`)
            .then(response => response.json())
            .then(data => {
                console.log(data);
                const chatBox = document.getElementById("chat-box");
                chatBox.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏Å‡πà‡∏≠‡∏ô
                data.forEach(msg => {
                    const messageDiv = document.createElement("div");
                    messageDiv.innerHTML = `<b>${msg.name}:</b> ${msg.message}`;
                    chatBox.appendChild(messageDiv);
                });
            })
            .catch(error => console.error("Error loading chat history:", error));
    }

    function leaveMeet() {
        console.log("leave meet.");

        if (currentRoomId !== 0) {
            console.log(`Sending leave message for room: ${currentRoomId} and user: ${currentUserId}`);
            socket.send(JSON.stringify({
                type: "leave",
                room_id: currentRoomId,
                user_id: currentUserId
            }));
        }

        // ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏•‡∏ö peerConnections ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        for (let id in peerConnections) {
            if (peerConnections[id]) {
                console.log(`Closing peer connection for user: ${id}`);
                peerConnections[id].close();
            }
        }
        peerConnections = {};

        // ‡∏´‡∏¢‡∏∏‡∏î local stream ‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á/‡πÑ‡∏°‡∏Ñ‡πå
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
            console.log("Local stream stopped.");
        }

        // ‡∏•‡πâ‡∏≤‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ local
        const localVideo = document.getElementById("localVideo");
        if (localVideo) localVideo.srcObject = null;

        // ‡∏•‡πâ‡∏≤‡∏á‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ remote ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        const remoteVideosContainer = document.getElementById("remoteVideosContainer");
        if (remoteVideosContainer) {
            remoteVideosContainer.innerHTML = "";
        }

        console.log("‚úÖ All peer connections closed and video streams cleared.");
    }

    async function selectRoomChat(roomId, roomName) {
        console.log(`Attempting to select room: ${roomId} (${roomName})`);
        if (roomId !== currentRoomId) {

            if (Object.keys(peerConnections).length > 0) {
                console.log("There are active peer connections, leaving the meeting...");
                leaveMeet();
            }

            const chatHeader = document.getElementById("chat-header");
            const chatBox = document.getElementById("chat-box");
            const meetbox = document.getElementById("meet-box");
            meetbox.style.display = 'block';

            // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡πâ‡∏≠‡∏á
            chatHeader.innerText = `${roomName}`;

            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏à‡∏≤‡∏Å div ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            currentRoomId = roomId;
            console.log(`Joining room ${currentRoomId} for user: ${currentUserId}`);
            socket.send(JSON.stringify({
                type: "join",
                room_id: currentRoomId,
                user_id: currentUserId
            }));
            // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ä‡∏ó‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡∏°‡πà
            await loadChat(roomId, roomName);
        }
    };

    async function videocall() {
        if (navigator.mediaDevices) {
            console.log("navigator.mediaDevices is available");
        } else {
            console.error("navigator.mediaDevices is not available");
        }
        const panel = document.getElementById("settingPanel");
        panel.style.display = "flex";
        panel.innerHTML = `
        <div class="d-flex justify-content-between">
            <div class="fs-4">Settings</div>
            <button style="border: 0; background-color: #ffffff00;" onclick="toggleControl()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="fs-6">Camera</div>
        <select id="cam-select"></select>
        <div class="fs-6">Audio</div>
        <select id="mic-select"></select>
        `;

        navigator.mediaDevices.enumerateDevices()
            .then(devices => {
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                const audioDevices = devices.filter(device => device.kind === 'audioinput');

                const camSelect = document.getElementById('cam-select');
                camSelect.className = 'form-select mb-2';

                const micSelect = document.getElementById('mic-select');
                micSelect.className = 'form-select mb-2';

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡πâ‡∏≠‡∏á
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Camera ${index + 1}`;
                    camSelect.appendChild(option);
                });

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡∏Ñ‡πå
                audioDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Microphone ${index + 1}`;
                    micSelect.appendChild(option);
                });

                if (videoDevices.length == 0) {
                    const option = document.createElement('option');
                    option.value = "";
                    option.text = "-- No Device --";
                    camSelect.appendChild(option);
                    camSelect.setAttribute("disabled", "disabled");
                }
                if (audioDevices.length == 0) {
                    const option = document.createElement('option');
                    option.value = "";
                    option.text = "-- No Device --";
                    micSelect.appendChild(option);
                    micSelect.setAttribute("disabled", "disabled");
                }
                const button = document.createElement('button');
                button.textContent = "Confirm";
                button.className = "form-control";
                button.onclick = () => Confirm_connect(camSelect, micSelect);
                panel.appendChild(button);

                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
                camSelect.addEventListener('change', () => {
                    const selectedCamId = camSelect.value;
                    const selectedMicId = micSelect.value;
                    startVideo(selectedCamId, selectedMicId);
                });

                micSelect.addEventListener('change', () => {
                    const selectedCamId = camSelect.value;
                    const selectedMicId = micSelect.value;
                    startVideo(selectedCamId, selectedMicId);
                });
            })
            .catch(err => {
                console.error("‚ùå Error enumerating devices:", err);
            });
    }

    async function Confirm_connect(camSelect, micSelect) {
        const videoEl = document.getElementById("localVideo");
        console.log("Confirming connection with selected camera and microphone.");
        if (Object.keys(peerConnections).length > 0) {
            console.log("Closing active peer connections before confirming.");
            leaveMeet();
        }

        toggleSettingPanel();
        const panel = document.getElementById("settingPanel");
        const stream = await startVideo(camSelect.value, micSelect.value);
        if (stream) {
            console.log("Starting video with selected devices.");
            socket.send(JSON.stringify({
                type: "new-peer",
            }));
        }
    }

    async function startVideo(deviceId, audioId) {
        console.log(`Starting video with deviceId: ${deviceId}, audioId: ${audioId}`);
        try {
            let stream;

            try {
                // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏Ç‡∏≠ video + audio stream
                stream = await navigator.mediaDevices.getUserMedia({
                    video: deviceId ? { deviceId: { exact: deviceId } } : true,
                    audio: audioId ? { deviceId: { exact: audioId } } : true,
                });
                console.log("‚úÖ Got video+audio stream", stream);
            } catch (err) {
                console.warn("‚ö†Ô∏è Failed to get audio, trying video only...", err);

                // ‡∏ñ‡πâ‡∏≤ audio error, fallback ‡∏Ç‡∏≠ video ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                stream = await navigator.mediaDevices.getUserMedia({
                    video: deviceId ? { deviceId: { exact: deviceId } } : true,
                });
                console.log("‚úÖ Got video stream only", stream);
            }

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ video preview ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö stream
            const localVideo = document.getElementById("localVideo");
            if (localVideo) localVideo.srcObject = stream;
            localStream = stream;

            return stream;

        } catch (error) {
            console.error("‚ùå Cannot access media devices:", error);
            return null;
        }
    }

    socket.onopen = function () {
        console.log("Connected to WebSocket");
    };

    socket.onmessage = async function (event) {
        const data = JSON.parse(event.data);
        const fromId = data.sender_id;
        switch (data.type) {
            case "join":
            case "leave":
            case "chat":
                displayMessage(data.name, data.message);
                break;
            case "offer":
                console.log(`Handling offer from user ${fromId}`);
                await handleOffer(data.offer, data.sender_id);
                break;
            case "answer":
                console.log(`Handling answer from user ${fromId}`);
                await handleAnswer(data.answer, data.sender_id);
                break;
            case "candidate":
                console.log(`Handling candidate from user ${fromId}`);
                await handleCandidate(data.candidate, data.sender_id);
                break;
            case "new-peer":
                console.log(`Handling new peer connection for user ${data.new_user_id}`);
                await createOfferTo(data.new_user_id);
                break;
            default:
                console.warn("Unknown message type:", data.type);
        }
    };

    async function handleOffer(offer, fromId) {
        console.log(`üì® Received offer from: ${fromId}`);
        await createPeerConnection(fromId);
        await peerConnections[fromId].setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peerConnections[fromId].createAnswer();
        await peerConnections[fromId].setLocalDescription(answer);
        socket.send(JSON.stringify({
            type: "answer",
            answer,
            room_id: currentRoomId,
            from_user_id: currentUserId,
            target_id: fromId
        }));
    }

    async function handleAnswer(answer, fromId) {
        console.log(`üì® Received answer from: ${fromId}`);
        if (peerConnections[fromId]) {
            await peerConnections[fromId].setRemoteDescription(new RTCSessionDescription(answer));
        }
    }

    async function handleCandidate(candidate, fromId) {
        console.log(`üì® Received candidate from: ${fromId}`);
        if (peerConnections[fromId]) {
            await peerConnections[fromId].addIceCandidate(new RTCIceCandidate(candidate));
        }
    }

    function createPeerConnection(targetId) {
        if (peerConnections[targetId]) return;

        console.log(`Creating new peer connection for targetId: ${targetId}`);
        const pc = new RTCPeerConnection({
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        });

        peerConnections[targetId] = pc;

        pc.onicecandidate = event => {
            if (event.candidate) {
                console.log(`Sending ICE candidate to ${targetId}`);
                socket.send(JSON.stringify({
                    type: "candidate",
                    candidate: event.candidate,
                    room_id: currentRoomId,
                    from_user_id: currentUserId,
                    target_id: targetId
                }));
            }
        };

        pc.ontrack = event => {
            console.log(`Received track from peer: ${targetId}`);
            let remoteVideo = document.getElementById(`remote-${targetId}`);
            if (!remoteVideo) {
                remoteVideo = document.createElement("video");
                remoteVideo.id = `remote-${targetId}`;
                remoteVideo.autoplay = true;
                remoteVideo.playsInline = true;
                document.getElementById("remoteVideos").appendChild(remoteVideo);
            }
            remoteVideo.srcObject = event.streams[0];
        };

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° local track
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        return pc;
    }

    async function createOfferTo(targetId) {
        console.log(`Creating offer to targetId: ${targetId}`);
        await createPeerConnection(targetId);
        const offer = await peerConnections[targetId].createOffer();
        await peerConnections[targetId].setLocalDescription(offer);

        socket.send(JSON.stringify({
            type: "offer",
            offer,
            room_id: currentRoomId,
            from_user_id: currentUserId,
            target_id: targetId
        }));
    }

</script>