<script>
    // const socket = new WebSocket("wss://localhost:8085/");
    const socket = new WebSocket("wss://49.0.69.152:8085/");

    let peerConnections = {};
    let localStream = null;
    let secondSteam = null;
    let currentRoomId = null;
    let currentRoomName = null;
    let currentUserId = "<?php echo $_SESSION['user']['id']; ?>";
    let remoteVideo = document.getElementById("remoteVideo");
    let localVideo = document.getElementById('localVideo');

    let micEnabled = true;
    let camEnabled = true;

    const config = {
        iceServers: [
            { urls: "stun:stun.l.google.com:19302" }
        ]
    };

    document.addEventListener("DOMContentLoaded", () => {
        loadChatRooms();
    });

    async function loadChatRooms() {
        try {
            const chatAccessRes = await fetch("../config/chat_access.php");
            const chat_access = await chatAccessRes.json();

            const res = await fetch("../config/chat-loadrooms.php");
            const data = await res.json();

            const select = document.getElementById("list-room-chat");
            select.innerHTML = "";
            const currentUserId = "<?php echo $_SESSION['user_id']; ?>"; // ใช้เฉพาะถ้า JS อยู่ใน .php

            for (const room of data) {
                for (const ca of chat_access) {
                    if (ca.user_id == currentUserId && ca.chat_room_id == room.id) {

                        // fetch ข้อความล่าสุด
                        const response_ = await fetch(`../config/chat-last.php?room_id=${room.id}`);
                        const chatroom = await response_.json();
                        const lastMessage = chatroom && chatroom.message ? chatroom.message : "[ไม่มีข้อความ]";

                        // จำกัดความยาวของข้อความ
                        const maxLength = 30; // ความยาวสูงสุดของข้อความที่จะแสดง
                        const truncatedMessage = lastMessage.length > maxLength ? lastMessage.substring(0, maxLength) + "..." : lastMessage;

                        // สร้าง div สำหรับห้อง
                        const div = document.createElement("div");
                        div.id = "room_" + room.id;
                        div.className = "box-chat px-4";
                        div.style.borderBottom = "1px solid #ddd";
                        div.onclick = () => selectRoomChat(room.id, room.name);

                        // ✅ ชื่อห้อง
                        const name = document.createElement("div");
                        name.className = "fw-bold py-2";
                        name.innerText = room.name;

                        // ✅ ข้อความล่าสุด
                        const preview = document.createElement("div");
                        preview.className = "text-muted small pb-2";
                        preview.innerText = truncatedMessage;

                        // ใส่ใน div หลัก
                        div.appendChild(name);
                        div.appendChild(preview);
                        select.appendChild(div);
                    }
                }
            }
        } catch (error) {
            console.error("เกิดข้อผิดพลาด:", error);
        }
    }

    async function toggleControl() {
        const videocallbox = document.getElementById('videocall-box');
        const infobox = document.getElementById('infomation-box');
        const commubox = document.getElementById('commu-box');
        await toggleDisplay(videocallbox, infobox);
        togglewidthVideoandChats(commubox, videocallbox);
    }

    async function toggleDisplay(Element1, Element2) {

        const meetbox = document.getElementById('meet-box');
        let toggle = Element1.style.visibility == 'hidden';
        if (toggle) {
            Element1.style.visibility = "visible";
            Element2.style.visibility = "hidden";
            Element1.style.display = "block";
            Element2.style.display = "none";
            meetbox.style.display = 'none';
            await videocall();

        } else {
            Element1.style.visibility = "hidden";
            Element2.style.visibility = "visible";
            Element1.style.display = "none";
            Element2.style.display = "block";
            meetbox.style.display = 'block';
            leaveMeet();
        }
    }

    function togglewidthVideoandChats(chatbox, videocallbox) {
        let toggleclass = chatbox.classList.contains('col-lg-7');
        chatbox.classList.replace(toggleclass ? 'col-lg-7' : 'col-lg-3', toggleclass ? 'col-lg-3' : 'col-lg-7')
        if (videocallbox.classList.contains('col-7')) {
            videocallbox.classList.remove('col-7');
            videocallbox.classList.remove('d-flex');
        } else {
            videocallbox.classList.add('col-7');
            videocallbox.classList.add('d-flex');
        }
    }

    function toggleSettingPanel() {
        const panel = document.getElementById("settingPanel");
        if (panel.style.display === "none" || panel.style.display === "") {
            panel.style.display = "flex"; // หรือ "block" ถ้าไม่ใช้ flex
        } else {
            panel.style.display = "none";
        }
    }

    function toggleChatRoom() {
        let listRoomChatBox = document.getElementById('box-list-room-chat');
        let commubox = document.getElementById('commu-box');
        // ตรวจสอบค่าของ display
        if (listRoomChatBox.style.display === "none") {
            listRoomChatBox.style.display = "block";
            commubox.style.display = "none";
        } else {
            listRoomChatBox.style.display = "none";
            commubox.style.display = "block";
        }

    }

    window.addEventListener("resize", () => {
        let listRoomChatBox = document.getElementById('box-list-room-chat');
        let chatBox = document.getElementById("commu-box");
        // ตรวจสอบขนาดหน้าจอ
        if (window.innerWidth < 992) {
            listRoomChatBox.style.display = "none";
            // chatBox.style.display.display = "none";
        } else {
            listRoomChatBox.style.display = "block";
            // chatBox.style.display.display = "block";
        }
    });

    document.getElementById('chat-message').addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            sendMessage(); // หรือฟังก์ชันของคุณ
        }
    });

    function displayMessage(name, message) {
        const chatBox = document.getElementById("chat-box");
        const messageDiv = document.createElement("div");
        messageDiv.innerHTML = `<b>${name}:</b> ${message}`;
        chatBox.appendChild(messageDiv);
    }

    function sendMessage() {
        const input = document.getElementById("chat-message");
        const msg = input.value;

        const message = {
            type: "chat",
            room_id: currentRoomId, // ไอดีห้องแชทที่เลือก
            user_id: "<?php echo $_SESSION['user_id']; ?>",
            name: "<?php echo $_SESSION['user']['name']; ?>",
            message: input.value
        };

        if (msg.trim() !== "") {
            socket.send(JSON.stringify(message)); // ส่งไปยัง WebSocket server
            input.value = "";
        }
    }

    async function createRoomChat() {
        let headerBox = document.getElementById('header-box');
        let createchat = document.getElementById('create-chat');
        if (createchat) {
            createchat.remove();
        }

        let res = await fetch("../config/Fetch_user.php");
        let users = await res.json();
        // สร้าง container ล้อม input กับ suggestionBox ให้จัดตำแหน่งแบบ relative
        let inputWrapper = document.createElement('div');
        inputWrapper.id = "create-chat";
        inputWrapper.style.position = 'relative';
        inputWrapper.style.width = '300px'; // ปรับตามความเหมาะสม
        inputWrapper.className = 'my-2 w-100';

        // สร้าง input สำหรับค้นหา
        let addmember = document.createElement('input');
        addmember.className = "form-control";
        addmember.placeholder = "ค้นหาเพื่อน เพื่อเริ่มแชท!";

        // สร้าง suggestion box (ลอยใต้ input)
        let suggestionBox = document.createElement('div');
        suggestionBox.style.position = 'absolute';
        suggestionBox.style.top = '100%';
        suggestionBox.style.left = '0';
        suggestionBox.style.right = '0';
        suggestionBox.style.zIndex = '1000';
        suggestionBox.className = "list-group shadow";

        // แทรก input และ suggestionBox เข้าใน wrapper
        inputWrapper.appendChild(addmember);
        inputWrapper.appendChild(suggestionBox);
        headerBox.appendChild(inputWrapper);

        addmember.addEventListener('input', function () {
            let query = addmember.value.toLowerCase();
            suggestionBox.innerHTML = ''; // ล้างรายการเก่า
            let matchedUsers = users.filter(user =>
                user['code'].toLowerCase().includes(query) ||
                user['name'].toLowerCase().includes(query)
            );

            matchedUsers.slice(0, 5).forEach(user => {
                let item = document.createElement('div');
                item.className = 'list-group-item list-group-item-action';
                item.textContent = user.name;

                item.addEventListener('click', async () => {
                    console.log("Selected user:", user.name);
                    addmember.value = '';
                    suggestionBox.innerHTML = '';
                    addRoomOfUser(currentUserId, user['id'], `new_chat[${currentUserId}${user['id']}]`);
                });

                suggestionBox.appendChild(item);
            });
        });

        addmember.addEventListener('keyup', async function (event) {
            if (event.key === 'Enter') {
                let query = addmember.value.toLowerCase();
                let matchedUsers = users.filter(user =>
                    user['code'].toLowerCase().includes(query) ||
                    user['name'].toLowerCase().includes(query)
                );

                if (matchedUsers.length > 0) {
                    let selectedUser = matchedUsers[0];
                    console.log("Selected (Enter) user:", selectedUser.name);
                    addmember.value = '';
                    suggestionBox.innerHTML = '';
                    addRoomOfUser(currentUserId, user['id'], `direct_room[${currentUserId}${user['id']}]`);
                }
            }
            if (event.key === 'Escape') { // ใช้ 'Escape' ไม่ใช่ 'esc'
                suggestionBox.innerHTML = '';
            }
        });

        addmember.addEventListener('blur', function () {
            setTimeout(() => {
                suggestionBox.innerHTML = '';
            }, 150); // หน่วงนิดนึง เผื่อผู้ใช้กำลังกดเลือก suggestion
        });

    }

    async function loadChat(roomId, roomName) {
        fetch("../config/chat-load.php?room_id=" + roomId)
            .then(res => res.json())
            .then(data => {
                const chatBox = document.getElementById("chat-box");
                chatBox.innerHTML = ""; // ล้างของเก่า
                data.forEach(msg => {
                    chatBox.innerHTML += `<div><strong>${msg.name}:</strong> ${msg.message}</div>`;
                });
            });
        let statusChat = document.getElementById("status-chat");
        await loadMember(roomId, roomName, statusChat);
    }

    async function loadMember(roomId, roomName, statusChat) {
        let response = await fetch("../config/chat-users.php?roomId=" + roomId);
        let chatroom = await response.json();
        let users_access = chatroom['users'];

        statusChat.innerHTML = "";

        let nameChat = document.getElementById("name-chat");
        // nameChat.textContent = roomName;
        nameChat.innerHTML = `
        <div class="d-flex justify-content-between">
            <div>
                <h4 id="name-room">${roomName}</h4>
                <input type="text" id="editRoomNameInput" class="form-control d-none" 
                onkeydown="if(event.key==='Enter') updateChatRoomName(${roomId})">
            </div>
            &nbsp
            <i class="bi bi-pencil-square fs-6" onclick="toggleChangeNameChat(${roomId})"></i>
        </div>
        
            `;
        users_access.forEach(user => {
            const div = document.createElement('div');
            div.className = "py-2";
            div.textContent = `${user.code} - ${user.name}`;
            statusChat.appendChild(div);
        });

        let res = await fetch("../config/Fetch_user.php");
        let users = await res.json();
        listMemberOfChatroom(users, statusChat);
    }

    function toggleChangeNameChat(id) {
        const roomNameText = document.getElementById("name-room");
        const input = document.getElementById("editRoomNameInput");

        // สลับการแสดงผล
        const isEditing = !input.classList.contains("d-none");

        if (isEditing) {
            // กำลังแก้ไข -> กลับเป็นแสดงข้อความ
            roomNameText.textContent = input.value;
            roomNameText.classList.remove("d-none");
            input.classList.add("d-none");
        } else {
            // กดเพื่อแก้ไข
            input.value = roomNameText.textContent;
            roomNameText.classList.add("d-none");
            input.classList.remove("d-none");
            input.focus();
        }
    }

    function updateChatRoomName(roomId) {
        const input = document.getElementById("editRoomNameInput");
        const newName = input.value.trim();

        if (newName === "") {
            alert("กรุณากรอกชื่อห้องใหม่");
            return;
        }

        fetch("../config/chat_nameupdate.php", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: `room_id=${roomId}&new_name=${encodeURIComponent(newName)}`
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    toggleChangeNameChat(); // ซ่อน input แล้วแสดงชื่อใหม่
                } else {
                    alert(data.message);
                }
            })
            .catch(err => {
                console.error("Error:", err);
            });
    }

    function listMemberOfChatroom(users, statusChat) {
        let Chatroom = document.getElementById('list-room-chat');

        // สร้าง container ล้อม input กับ suggestionBox ให้จัดตำแหน่งแบบ relative
        let inputWrapper = document.createElement('div');
        inputWrapper.style.position = 'relative';
        inputWrapper.style.width = '200px'; // ปรับตามความเหมาะสม
        inputWrapper.className = 'mb-3';

        // สร้าง input สำหรับค้นหา
        let addmember = document.createElement('input');
        addmember.className = "form-control";
        addmember.placeholder = "Add member to chat";

        // สร้าง suggestion box (ลอยใต้ input)
        let suggestionBox = document.createElement('div');
        suggestionBox.style.position = 'absolute';
        suggestionBox.style.top = '100%';
        suggestionBox.style.left = '0';
        suggestionBox.style.right = '0';
        suggestionBox.style.zIndex = '1000';
        suggestionBox.className = "list-group shadow";

        // แทรก input และ suggestionBox เข้าใน wrapper
        inputWrapper.appendChild(addmember);
        inputWrapper.appendChild(suggestionBox);
        statusChat.appendChild(inputWrapper);

        addmember.addEventListener('input', function () {
            let query = addmember.value.toLowerCase();
            suggestionBox.innerHTML = ''; // ล้างรายการเก่า
            let matchedUsers = users.filter(user =>
                user['code'].toLowerCase().includes(query) ||
                user['name'].toLowerCase().includes(query)
            );

            matchedUsers.slice(0, 5).forEach(user => {
                let item = document.createElement('div');
                item.className = 'list-group-item list-group-item-action';
                item.textContent = user.name;

                item.addEventListener('click', async () => {
                    console.log("Selected user:", user.name);
                    addmember.value = '';
                    suggestionBox.innerHTML = '';
                    addUserToChatRoom(currentRoomId, user['id']);
                    await loadMember(currentRoomId, currentRoomName, statusChat);
                });

                suggestionBox.appendChild(item);
            });
        });

        addmember.addEventListener('keyup', async function (event) {
            if (event.key === 'Enter') {
                let query = addmember.value.toLowerCase();
                let matchedUsers = users.filter(user =>
                    user['code'].toLowerCase().includes(query) ||
                    user['name'].toLowerCase().includes(query)
                );

                if (matchedUsers.length > 0) {
                    let selectedUser = matchedUsers[0];
                    console.log("Selected (Enter) user:", selectedUser.name);
                    addmember.value = '';
                    suggestionBox.innerHTML = '';
                    addUserToChatRoom(currentRoomId, selectedUser['id']);
                }
                await loadMember(currentRoomId, currentRoomName, statusChat);
            }
            if (event.key === 'Escape') { // ใช้ 'Escape' ไม่ใช่ 'esc'
                suggestionBox.innerHTML = '';
            }
        });

        addmember.addEventListener('blur', function () {
            setTimeout(() => {
                suggestionBox.innerHTML = '';
            }, 150); // หน่วงนิดนึง เผื่อผู้ใช้กำลังกดเลือก suggestion
        });

    }

    function addUserToChatRoom(chatRoomId, userId) {
        const formData = new FormData();
        formData.append('chat_room_id', chatRoomId);
        formData.append('user_id', userId);

        fetch('../config/chat-access-create.php', {
            method: 'POST',
            body: formData
        })
            .then(response => response.text())
            .then(result => {
                console.log(result);
            })
            .catch(error => {
                console.error('เกิดข้อผิดพลาด:', error);
                alert('เกิดข้อผิดพลาดในการเพิ่มผู้ใช้');
            });
    }

    async function addRoomOfUser(currentUserId, user_id, roomName) {
        try {
            // 1. เริ่มจากการสร้างห้องใหม่
            const createRoomResponse = await fetch('../config/chat-room-create.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ room_name: roomName })
            });

            const roomResult = await createRoomResponse.json();

            if (!roomResult.success) {
                console.error("❌ ไม่สามารถสร้างห้องได้:", roomResult.message);
                alert("ไม่สามารถสร้างห้องได้: " + roomResult.message);
                return;
            }

            const newRoomId = roomResult.room_id;

            await chat_access_create(newRoomId, currentUserId);
            await chat_access_create(newRoomId, user_id);

            await loadChatRooms();

        } catch (error) {
            console.error("เกิดข้อผิดพลาด:", error);
            alert("เกิดข้อผิดพลาด: " + error.message);
        }
    }

    async function chat_access_create(newRoomId, user_id) {
        // 2. หลังจากสร้างห้องแล้ว บันทึก chat_access
        const addAccessResponse = await fetch('../config/chat-access-create.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `chat_room_id=${encodeURIComponent(newRoomId)}&user_id=${encodeURIComponent(user_id)}`
        });


    }

    async function loadChatHistory(roomId) {
        fetch(`../config/chat-load.php?room_id=${roomId}`)
            .then(response => response.json())
            .then(data => {
                console.log(data);
                const chatBox = document.getElementById("chat-box");
                chatBox.innerHTML = ""; // ล้างกล่องแชทก่อน
                data.forEach(msg => {
                    const messageDiv = document.createElement("div");
                    messageDiv.innerHTML = `<b>${msg.name}:</b> ${msg.message}`;
                    chatBox.appendChild(messageDiv);
                });
            })
            .catch(error => console.error("Error loading chat history:", error));
    }

    function leaveMeet() {
        console.log("leaving meet.");

        if (currentRoomId !== 0) {
            console.log(`Sending leave message for room: ${currentRoomId} and user: ${currentUserId}`);
            socket.send(JSON.stringify({
                type: "leave",
                room_id: currentRoomId,
                user_id: currentUserId
            }));
        }

        // ปิดและลบ peerConnections ทั้งหมด
        for (let id in peerConnections) {
            if (peerConnections[id]) {
                console.log(`Closing peer connection for user: ${id}`);
                peerConnections[id].close();
            }
        }
        peerConnections = {};

        // หยุด local stream และปิดกล้อง/ไมค์
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
            console.log("Local stream stopped.");
        }

        // ล้างวิดีโอ local
        const localVideo = document.getElementById("localVideo");
        if (localVideo) localVideo.srcObject = null;

        // ล้างวิดีโอ remote ทั้งหมด
        const remoteVideosContainer = document.getElementById("remoteVideosContainer");
        if (remoteVideosContainer) {
            remoteVideosContainer.innerHTML = "";
        }

        console.log("✅ All peer connections closed and video streams cleared.");

    }

    function deletedRemoteVideo(sender_id) {

        let remote_sender = document.getElementById("remote-" + sender_id);
        // 1. ปิด PeerConnection
        if (peerConnections[sender_id]) {
            peerConnections[sender_id].close();
            delete peerConnections[sender_id];
        }

        if (remote_sender) {
            remote_sender.remove();
        }

        console.log(`👤 User ${sender_id} left the room`);
    }

    async function selectRoomChat(roomId, roomName) {
        console.log(`Attempting to select room: ${roomId} (${roomName})`);
        if (window.innerWidth < 992) { toggleChatRoom(); }
        if (roomId !== currentRoomId) {

            if (localStream || document.getElementById('videocall-box').style.display == "block") {
                leaveMeet();
                toggleControl();
            }

            const chatHeader = document.getElementById("chat-header");
            const chatBox = document.getElementById("chat-box");
            const meetbox = document.getElementById("meet-box");
            meetbox.style.display = 'block';

            // 1. อัปเดตบทเรียนห้อง
            chatHeader.innerText = `${roomName}`;

            // กำหนดห้องปัจจุบันใหม่ จาก div ที่เลือก
            currentRoomName = roomName;
            currentRoomId = roomId;
            console.log(`Joining room ${currentRoomId} for user: ${currentUserId}`);
            socket.send(JSON.stringify({
                type: "join",
                room_id: currentRoomId,
                user_id: currentUserId
            }));
            // โหลดแชทของห้องแชทใหม่
            await loadChat(roomId, roomName);
        }
    };

    async function videocall() {
        if (navigator.mediaDevices) {
            console.log("navigator.mediaDevices is available");
        } else {
            console.error("navigator.mediaDevices is not available");
        }
        const panel = document.getElementById("settingPanel");
        panel.style.display = "flex";
        panel.innerHTML = `
        <div class="d-flex justify-content-between">
            <div class="fs-4"><?=$lang['setting']?></div>
            <button style="border: 0; background-color: #ffffff00;" onclick="toggleSettingPanel()">
                <i class="bi bi-x"></i>
            </button>
        </div>
        <div class="fs-6"><?=$lang['camera']?></div>
        <select id="cam-select"></select>
        <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="enableCamera" checked>
            <label class="form-check-label" for="enableCamera"><?=$lang['open']?><?=$lang['camera']?></label>
        </div>
        <div class="fs-6"><?=$lang['audio']?></div>
        <select id="mic-select"></select>
        <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="enableMic" checked>
            <label class="form-check-label" for="enableMic"><?=$lang['open']?><?=$lang['audio']?></label>
        </div>
        `;

        navigator.mediaDevices.enumerateDevices()
            .then(devices => {
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                const audioDevices = devices.filter(device => device.kind === 'audioinput');

                const camSelect = document.getElementById('cam-select');
                camSelect.className = 'form-select mb-2';

                const micSelect = document.getElementById('mic-select');
                micSelect.className = 'form-select mb-2';

                // สร้างตัวเลือกกล้อง
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Camera ${index + 1}`;
                    camSelect.appendChild(option);
                });

                // สร้างตัวเลือกไมค์
                audioDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Microphone ${index + 1}`;
                    micSelect.appendChild(option);
                });

                if (videoDevices.length == 0) {
                    const option = document.createElement('option');
                    option.value = "";
                    option.text = "-- No Device --";
                    camSelect.appendChild(option);
                    camSelect.setAttribute("disabled", "disabled");
                }
                if (audioDevices.length == 0) {
                    const option = document.createElement('option');
                    option.value = "";
                    option.text = "-- No Device --";
                    micSelect.appendChild(option);
                    micSelect.setAttribute("disabled", "disabled");
                }
                const button = document.createElement('button');
                button.innerHTML = `<?=$lang['confirm']?>`;
                button.className = "form-control";
                button.onclick = () => Confirm_connect(camSelect, micSelect);
                panel.appendChild(button);

                // เมื่อเปลี่ยนอุปกรณ์
                camSelect.addEventListener('change', () => {
                    const selectedCamId = camSelect.value;
                    const selectedMicId = micSelect.value;
                    startVideo(selectedCamId, selectedMicId);
                });

                micSelect.addEventListener('change', () => {
                    const selectedCamId = camSelect.value;
                    const selectedMicId = micSelect.value;
                    startVideo(selectedCamId, selectedMicId);
                });
            })
            .catch(err => {
                console.error("❌ Error enumerating devices:", err);
            });
    }

    async function Confirm_connect(camSelect, micSelect) {
        const videoEl = document.getElementById("localVideo");

        console.log("Confirming connection with selected camera and microphone.");
        if (Object.keys(peerConnections).length > 0) {
            console.log("Closing active peer connections before confirming.");
            leaveMeet();
        }

        toggleSettingPanel();
        const panel = document.getElementById("settingPanel");
        const stream = await startVideo(camSelect.value, micSelect.value);
        if (stream) {
            console.log("Starting video with selected devices.");
            socket.send(JSON.stringify({
                type: "new-peer",
            }));
            const enableCamera = document.getElementById("enableCamera").checked;
            const enableMic = document.getElementById("enableMic").checked;
            EnableCam(enableCamera);
            EnableMic(enableMic);
        }
    }

    async function startVideo(deviceId, audioId) {
        try {
            let stream;

            try {
                // พยายามขอ video + audio stream
                stream = await navigator.mediaDevices.getUserMedia({
                    video: deviceId ? { deviceId: { exact: deviceId } } : true,
                    audio: audioId ? { deviceId: { exact: audioId } } : true,
                });
                console.log("✅ Got video+audio stream", stream);
            } catch (err) {
                console.warn("⚠️ Failed to get audio, trying video only...", err);

                // ถ้า audio error, fallback ขอ video อย่างเดียว
                stream = await navigator.mediaDevices.getUserMedia({
                    video: deviceId ? { deviceId: { exact: deviceId } } : true,
                });
                console.log("✅ Got video stream only", stream);
            }

            // ตั้งค่า video preview และเก็บ stream
            const localVideo = document.getElementById("localVideo");
            if (localVideo) localVideo.srcObject = stream;
            localStream = stream;

            return stream;

        } catch (error) {
            console.error("❌ Cannot access media devices:", error);
            return null;
        }
    }

    socket.onopen = function () {
        console.log("Connected to WebSocket");
    };

    socket.onmessage = async function (event) {
        const data = JSON.parse(event.data);
        const fromId = data.sender_id;
        switch (data.type) {
            case "join":
            case "chat":
                displayMessage(data.name, data.message);
                break;
            case "offer":
                console.log(`Handling offer from user ${fromId}`);
                await handleOffer(data.offer, fromId);
                break;
            case "answer":
                console.log(`Handling answer from user ${fromId}`);
                await handleAnswer(data.answer, fromId);
                break;
            case "candidate":
                console.log(`Handling candidate from user ${fromId}`);
                await handleCandidate(data.candidate, fromId);
                break;
            case "new-peer":
                console.log(`Handling new peer connection for user ${data.new_user_id}`);
                await createOfferTo(data.new_user_id);
                break;
            case "leave":
                await deletedRemoteVideo(fromId);
                break;
            default:
                console.warn("Unknown message type:", data.type);
        }
    };

    async function handleOffer(offer, fromId) {
        console.log(`📨 Received offer from: ${fromId}`);
        await createPeerConnection(fromId);
        await peerConnections[fromId].setRemoteDescription(new RTCSessionDescription(offer));
        const answer = await peerConnections[fromId].createAnswer();
        await peerConnections[fromId].setLocalDescription(answer);
        socket.send(JSON.stringify({
            type: "answer",
            answer,
            room_id: currentRoomId,
            from_user_id: currentUserId,
            target_id: fromId
        }));
    }

    async function handleAnswer(answer, fromId) {
        console.log(`📨 Received answer from: ${fromId}`);
        if (peerConnections[fromId]) {
            await peerConnections[fromId].setRemoteDescription(new RTCSessionDescription(answer));
        }
    }

    async function handleCandidate(candidate, fromId) {
        console.log(`📨 Received candidate from: ${fromId}`);
        if (peerConnections[fromId]) {
            await peerConnections[fromId].addIceCandidate(new RTCIceCandidate(candidate));
        }
    }

    function createPeerConnection(targetId) {
        if (peerConnections[targetId]) return;

        console.log(`Creating new peer connection for targetId: ${targetId}`);
        const pc = new RTCPeerConnection({
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        });

        peerConnections[targetId] = pc;

        pc.onicecandidate = event => {
            if (event.candidate) {
                console.log(`Sending ICE candidate to ${targetId}`);
                socket.send(JSON.stringify({
                    type: "candidate",
                    candidate: event.candidate,
                    room_id: currentRoomId,
                    from_user_id: currentUserId,
                    target_id: targetId
                }));
            }
        };

        pc.ontrack = event => {
            console.log(`Received track from peer: ${targetId}`);
            let remoteVideo = document.getElementById(`remote-${targetId}`);
            if (!remoteVideo) {
                remoteVideo = document.createElement("video");
                remoteVideo.id = `remote-${targetId}`;
                remoteVideo.autoplay = true;
                remoteVideo.playsInline = true;
                document.getElementById("remoteVideos").appendChild(remoteVideo);
            }
            remoteVideo.srcObject = event.streams[0];
        };

        // เพิ่ม local track
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

        console.log("peer list");
        console.log(pc);
        return pc;
    }

    async function createOfferTo(targetId) {
        console.log(`Creating offer to targetId: ${targetId}`);
        await createPeerConnection(targetId);
        const offer = await peerConnections[targetId].createOffer();
        await peerConnections[targetId].setLocalDescription(offer);

        socket.send(JSON.stringify({
            type: "offer",
            offer,
            room_id: currentRoomId,
            from_user_id: currentUserId,
            target_id: targetId
        }));
    }

    async function startScreenShare() {
        console.log("🔁 Starting screen share...");

        try {
            const screenStream = await navigator.mediaDevices.getDisplayMedia({
                video: true,
                audio: true // ถ้าต้องการแชร์เสียงหน้าจอ
            });

            // ตั้งค่าแสดง preview ที่ localVideo
            const localVideo = document.getElementById("localVideo");
            if (localVideo) {
                localVideo.srcObject = screenStream;
            }

            // เก็บไว้เป็น local stream ใหม่
            secondSteam = localStream;
            localStream = screenStream;

            // ส่ง track ใหม่ไปยัง peer ทุกคน
            for (let id in peerConnections) {
                const pc = peerConnections[id];

                // ลบ track เดิม
                const senders = pc.getSenders();
                senders.forEach(sender => {
                    if (sender.track && sender.track.kind === "video") {
                        pc.removeTrack(sender);
                    }
                });

                // เพิ่ม track ใหม่จากหน้าจอ
                screenStream.getTracks().forEach(track => {
                    pc.addTrack(track, screenStream);
                });

                // Re-negotiate ด้วย offer ใหม่
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                socket.send(JSON.stringify({
                    type: "offer",
                    offer,
                    room_id: currentRoomId,
                    from_user_id: currentUserId,
                    target_id: id
                }));
            }

            console.log("✅ Screen sharing started.");

            // เมื่อผู้ใช้กดหยุดแชร์หน้าจอ
            screenStream.getVideoTracks()[0].addEventListener("ended", () => {
                console.log("🛑 Screen sharing stopped.");
                // เรียกกลับไปยัง startVideo() เพื่อใช้กล้องแทน
                document.getElementById('btn-scrn-stop').style.display = 'none';
                document.getElementById('btn-scrn-start').style.display = 'block';
                startVideo();
            });

            document.getElementById('btn-scrn-start').style.display = 'none';
            document.getElementById('btn-scrn-stop').style.display = 'block';
        } catch (err) {
            console.error("❌ Failed to share screen:", err);
        }
    }

    async function stopScreenShare() {
        console.log("🛑 Stop screen sharing");

        // สลับ stream กลับ
        let screenStream = localStream;
        localStream = secondSteam;
        secondSteam = screenStream;

        // หยุด track ของ screen จริง ๆ (browser จะหยุดแชร์)
        screenStream.getTracks().forEach(track => {
            if (track.readyState === "live") {
                track.stop();
            }
        });

        // อัปเดต stream กลับไปยัง peer
        for (let id in peerConnections) {
            const pc = peerConnections[id];

            // หา sender เดิม
            const videoSender = pc.getSenders().find(s => s.track?.kind === "video");
            if (videoSender) {
                const newVideoTrack = localStream.getVideoTracks()[0];
                if (newVideoTrack) {
                    await videoSender.replaceTrack(newVideoTrack);
                }
            }

            const audioSender = pc.getSenders().find(s => s.track?.kind === "audio");
            if (audioSender) {
                const newAudioTrack = localStream.getAudioTracks()[0];
                if (newAudioTrack) {
                    await audioSender.replaceTrack(newAudioTrack);
                }
            }

            // (ถ้าจำเป็น) renegotiate ใหม่
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            socket.send(JSON.stringify({
                type: "offer",
                offer,
                room_id: currentRoomId,
                from_user_id: currentUserId,
                target_id: id
            }));
        }

        // แสดงกล้องบน localVideo อีกครั้ง
        const localVideo = document.getElementById("localVideo");
        if (localVideo) {
            localVideo.srcObject = localStream;
        }

        // ปรับ UI
        document.getElementById('btn-scrn-start').style.display = 'inline-block';
        document.getElementById('btn-scrn-stop').style.display = 'none';

        console.log("🎥 Reverted to camera stream.");
    }

    function toggleMic() {
        if (!localStream) return;

        micEnabled = !micEnabled;
        localStream.getAudioTracks().forEach(track => {
            track.enabled = micEnabled;
        });

        const micBtn = document.getElementById("btn-mic");
        micBtn.innerHTML = micEnabled ? `<i class="bi bi-mic-fill"></i>` : `<i class="bi bi-mic-mute-fill"></i>`;
        micBtn.className = micEnabled ? "btn btn-outline-light" : "btn btn-danger";
    }

    function toggleCam() {
        if (!localStream) return;

        camEnabled = !camEnabled;
        localStream.getVideoTracks().forEach(track => {
            track.enabled = camEnabled;
        });

        const camBtn = document.getElementById("btn-cam");
        camBtn.innerHTML = camEnabled ? `<i class="bi bi-camera-video-fill"></i>` : `<i class="bi bi-camera-video-off-fill"></i>`;
        camBtn.className = camEnabled ? "btn btn-outline-light" : "btn btn-danger";
    }

    function EnableMic(enabled) {
        const micBtn = document.getElementById("btn-mic");
        if (enabled) {
            micBtn.removeAttribute("disabled");
            micBtn.innerHTML = `<i class="bi bi-mic-fill"></i>`;
            micBtn.className = "btn btn-outline-light";
        }
        else {
            micBtn.setAttribute("disabled", "disabled");
            micBtn.innerHTML = `<i class="bi bi-mic-mute-fill"></i>`;
            micBtn.className = "btn btn-danger";
            localStream.getAudioTracks().forEach(track => {
                track.enabled = false;
            });
        }
        return;
    }

    function EnableCam(enabled) {
        const camBtn = document.getElementById("btn-cam");
        if (enabled) {
            camBtn.removeAttribute("disabled");
            camBtn.innerHTML = `<i class="bi bi-camera-video-fill"></i>`;
            camBtn.className = "btn btn-outline-light";
        }
        else {
            camBtn.setAttribute("disabled", "disabled");
            camBtn.innerHTML = `<i class="bi bi-camera-video-off-fill"></i>`;
            camBtn.className = "btn btn-danger";
            localStream.getVideoTracks().forEach(track => {
                track.enabled = false;
            });
        }
        return;
    }

    function toggleChat() {
        const chatBox = document.getElementById('chatBotBox');
        const btnBot = document.getElementById('btn-bot');
        if (chatBox.style.display === 'none') {
            chatBox.style.display = 'block';
            btnBot.innerHTML = `<i class="bi bi-x-lg px-1"></i>`;

        } else {
            chatBox.style.display = 'none';
            btnBot.innerHTML = `<i class="bi bi-robot px-1"></i>`;
        }
    }

    sendMessageToBotByString("9900");
    function sendMessageToBot() {

        const input = document.getElementById('chatInput');
        message = input.value.trim();
        if (message) {
            const chatMessages = document.getElementById('chatMessages');
            const newMsg = document.createElement('div');
            newMsg.className = "w-100 text-end"
            newMsg.textContent = message;
            newMsg.style.margin = '5px 0';
            chatMessages.appendChild(newMsg);
            input.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // 2. ส่งข้อความไปที่ chatbot.php
            fetch('../config/chat-bot.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: message })
            })
                .then(response => response.json())
                .then(data => {
                    setTimeout(() => {
                        const botMsg = document.createElement('div');
                        const boxmessage = document.createElement('div');
                        boxmessage.className = "w-100 d-flex";
                        boxmessage.style.textAlign = 'left';
                        boxmessage.innerHTML = `
                        <i class="bi bi-robot px-1">
                        `;
                        botMsg.textContent = data.reply;
                        botMsg.style.margin = '5px 0';
                        boxmessage.appendChild(botMsg);
                        chatMessages.appendChild(boxmessage);

                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }, 1500);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
    }

    function sendMessageToBotByString(message) {
        // 2. ส่งข้อความไปที่ chatbot.php
        fetch('../config/chat-bot.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: message })
        })
            .then(response => response.json())
            .then(data => {
                // 3. แสดงข้อความตอบกลับของบอท
                const botMsg = document.createElement('div');
                const boxmessage = document.createElement('div');
                boxmessage.className = "w-100 d-flex";
                boxmessage.style.textAlign = 'left';
                boxmessage.innerHTML = `
                        <i class="bi bi-robot px-1">
                        `;
                botMsg.textContent = data.reply;
                botMsg.style.margin = '5px 0';
                boxmessage.appendChild(botMsg);
                chatMessages.appendChild(boxmessage);

                // เลื่อนลงล่างสุด
                chatMessages.scrollTop = chatMessages.scrollHeight;
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    // ฟังการกดปุ่ม Escape เพื่อปิด Chat Box
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            const chatBox = document.getElementById('chatBotBox');
            if (chatBox.style.display == "block") {
                toggleChat();
            }
        }
    });
</script>