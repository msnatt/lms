<!-- page product -->
<script>
    const socket = new WebSocket("ws://localhost:8085");
    let currentRoomId = 0;
    let peerConnection = null;
    const currentUserId = "<?php echo $_SESSION['user']['id']; ?>";

    document.addEventListener("DOMContentLoaded", () => {
        loadChatRooms();
    });

    async function loadChatRooms() {
        try {
            const chatAccessRes = await fetch("../config/chat_access.php");
            const chat_access = await chatAccessRes.json();

            const res = await fetch("../config/chat-loadrooms.php");
            const data = await res.json();

            const select = document.getElementById("list-room-chat");
            const currentUserId = "<?php echo $_SESSION['user_id']; ?>"; // ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤ JS ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô .php

            for (const room of data) {
                for (const ca of chat_access) {
                    if (ca.user_id == currentUserId && ca.chat_room_id == room.id) {

                        // fetch ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                        const response_ = await fetch(`../config/chat-last.php?room_id=${room.id}`);
                        const chatroom = await response_.json();
                        const lastMessage = chatroom.message ?? "[‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°]";

                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á div ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á
                        const div = document.createElement("div");
                        div.id = "room_" + room.id;
                        div.className = "gap-1 box-chat m-1";
                        div.onclick = () => selectRoomChat(room.id, room.name);

                        // ‚úÖ ‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á
                        const name = document.createElement("div");
                        name.className = "fw-bold";
                        name.innerText = room.name;

                        // ‚úÖ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                        const preview = document.createElement("div");
                        preview.className = "text-muted small";
                        preview.innerText = lastMessage;

                        // ‡πÉ‡∏™‡πà‡πÉ‡∏ô div ‡∏´‡∏•‡∏±‡∏Å
                        div.appendChild(name);
                        div.appendChild(preview);
                        select.appendChild(div);
                    }
                }
            }
        } catch (error) {
            console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:", error);
        }
    }

    async function toggleControl() {
        const videocallbox = document.getElementById('videocall-box');
        const infobox = document.getElementById('infomation-box');
        const commubox = document.getElementById('commu-box');
        await toggleDisplay(videocallbox, infobox);
        togglewidthVideoandChats(commubox, videocallbox);
    }

    async function toggleDisplay(Element1, Element2) {
        const meetbox = document.getElementById('meet-box');
        let toggle = Element1.style.display == 'none';
        if (toggle) {
            Element1.style.display = 'block';
            Element2.style.display = 'none';
            meetbox.style.display = 'none';
            await videocall();
        } else {
            Element1.style.display = 'none';
            Element2.style.display = 'block';
            meetbox.style.display = 'block';
        }
    }

    function togglewidthVideoandChats(commubox, videocallbox) {
        let toggleclass = commubox.classList.contains('col-lg-8');
        commubox.classList.replace(toggleclass ? 'col-lg-8' : 'col-lg-2', toggleclass ? 'col-lg-2' : 'col-lg-8')
        if (videocallbox.classList.contains('col-8')) {
            videocallbox.classList.remove('col-8');
        } else {
            videocallbox.classList.add('col-8');
        }
    }

    async function videocall() {

        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        peerConnection = new RTCPeerConnection();

        let localStream = null;

        // show device ID connected to this pc.
        // navigator.mediaDevices.enumerateDevices()
        //     .then(devices => {
        //         devices.forEach(device => {
        //             console.log(`${device.kind}: ${device.label} [${device.deviceId}]`);
        //         });
        //     });

        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localVideo.srcObject = stream;
                localStream = stream;

                // ‚úÖ ‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ addTrack ‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // ‚úÖ ‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ createOffer ‡∏°‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
                peerConnection.createOffer().then(offer => {
                    peerConnection.setLocalDescription(offer);
                    socket.send(JSON.stringify({ type: "join", room_id: currentRoomId, user_id: currentUserId }));
                    socket.send(JSON.stringify({ type: "offer", offer }));
                });
            })
            .catch(err => {
                console.error("Cannot access media devices:", err);
            });

        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì remote
        peerConnection.ontrack = event => {
            remoteVideo.srcObject = event.streams[0];
        };


    }

    socket.onopen = function () {
        console.log("Connected to WebSocket");
        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏´‡πâ‡∏≠‡∏á" ‡πÉ‡∏´‡πâ server ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏™‡∏£‡πá‡∏à

    };

    socket.onmessage = async function (event) {
        const data = JSON.parse(event.data);
        switch (data.type) {
            case "join":
                displayMessage(data.name, data.message);
                break;
            case "leave":
                displayMessage(data.name, data.message);
                break;
            case "chat":
                displayMessage(data.name, data.message);
                break;
            case "offer":
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.send(JSON.stringify({
                    type: "answer",
                    answer: answer,
                    to_user_id: data.from_user_id // üëà ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏ñ‡∏π‡∏Å‡∏ù‡∏±‡πà‡∏á
                }));
                break;
            case "answer":
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                break;
            case "candidate":
                if (data.candidate) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                }
                break;
            default:
                console.warn("Unknown message type:", data.type);
        }
    };

    async function shareScreen() {
        const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        screenStream.getTracks().forEach(track => {
            peerConnection.addTrack(track, screenStream);
        });
    }
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô chat box
    function displayMessage(name, message) {
        const chatBox = document.getElementById("chat-box");
        const messageDiv = document.createElement("div");
        messageDiv.innerHTML = `<b>${name}:</b> ${message}`;
        chatBox.appendChild(messageDiv);
    }

    function sendMessage() {
        const input = document.getElementById("chat-message");
        const msg = input.value;

        const message = {
            type: "chat",
            room_id: currentRoomId, // ‡πÑ‡∏≠‡∏î‡∏µ‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            user_id: "<?php echo $_SESSION['user_id']; ?>",
            name: "<?php echo $_SESSION['user']['name']; ?>",
            message: input.value
        };

        if (msg.trim() !== "") {
            socket.send(JSON.stringify(message)); // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á WebSocket server
            input.value = "";
        }
    }

    async function selectRoomChat(roomId, roomName) {
        // ‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠(‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if (peerConnection) {
            leaveMeet();
        }

        const chatHeader = document.getElementById("chat-header");
        const chatBox = document.getElementById("chat-box");
        const meetbox = document.getElementById("meet-box");
        meetbox.style.display = 'block';

        // 1. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏´‡πâ‡∏≠‡∏á
        chatHeader.innerText = `${roomName}`;


        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà ‡∏à‡∏≤‡∏Å div ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        currentRoomId = roomId;
        // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ä‡∏ó‡∏Ç‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡πÉ‡∏´‡∏°‡πà
        await loadChat(roomId, roomName);

    };

    function leaveMeet() {
        // ‡∏™‡πà‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ leave chat ‡∏ö‡∏≠‡∏Å server 
        if (currentRoomId !== 0) {
            socket.send(JSON.stringify({
                type: "leave",
                room_id: currentRoomId,
                user_id: currentUserId
            }));
        }

        // ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
        peerConnection.close();
        peerConnection = null;

        // 5. ‡∏•‡πâ‡∏≤‡∏á video stream
        const localVideo = document.getElementById("localVideo");
        const remoteVideo = document.getElementById("remoteVideo");
        if (localVideo) localVideo.srcObject = null;
        if (remoteVideo) remoteVideo.srcObject = null;

    }

    async function loadChat(roomId, roomName) {

        fetch("../config/chat-load.php?room_id=" + roomId)
            .then(res => res.json())
            .then(data => {
                const chatBox = document.getElementById("chat-box");
                chatBox.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤
                data.forEach(msg => {
                    chatBox.innerHTML += `<div><strong>${msg.name}:</strong> ${msg.message}</div>`;
                });
            });

        let response = await fetch("../config/chat_users.php?roomId=" + roomId);
        let chatroom = await response.json();
        let users = chatroom['users'];

        let statusChat = document.getElementById("status-chat");
        statusChat.textContent = "";
        let nameChat = document.getElementById("name-chat");
        nameChat.textContent = roomName;
        users.forEach(user => {
            const div = document.createElement('div');
            div.className = "py-2";
            div.textContent = `${user.code} - ${user.name}`;
            // div.innerHTML = `

            // `;
            statusChat.appendChild(div);
        });
    }

    async function loadChatHistory(roomId) {
        fetch(`../config/chat-load.php?room_id=${roomId}`)
            .then(response => response.json())
            .then(data => {
                console.log(data);
                const chatBox = document.getElementById("chat-box");
                chatBox.innerHTML = ""; // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏Å‡πà‡∏≠‡∏ô
                data.forEach(msg => {
                    const messageDiv = document.createElement("div");
                    messageDiv.innerHTML = `<b>${msg.name}:</b> ${msg.message}`;
                    chatBox.appendChild(messageDiv);
                });
            })
            .catch(error => console.error("Error loading chat history:", error));
    }


</script>