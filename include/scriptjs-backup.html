<!-- page product -->
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        await generate_table();



    });

    async function loadBackup() {
        let response = await fetch('../config/get_backup.php');
        let json_res = response.json();
        return json_res;
    }

    async function generate_table() {
        let files = await loadBackup();

        let table = document.getElementById('table_backup').getElementsByTagName('tbody')[0];
        table.innerHTML = "";

        files.forEach(file => {
            let sizeMB = (file.size / 1024).toFixed(2); // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏õ‡πá‡∏ô MB (2 ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)

            let newRow = table.insertRow();
            newRow.className = "text-center";
            newRow.style.textAlign = "center";
            newRow.insertCell(0).innerHTML = file.modified;
            newRow.insertCell(1).innerHTML = file.name;
            newRow.insertCell(2).innerHTML = `${sizeMB} KB`;
            // üîΩ ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
            let downloadBtn = document.createElement("a");
            downloadBtn.href = `../backup/${file.name}`;
            downloadBtn.download = file.name;
            downloadBtn.className = "btn btn-sm btn-outline-success";
            downloadBtn.innerHTML = `<i class="bi bi-download"></i> Download`;

            let actionCell = newRow.insertCell(3);
            actionCell.appendChild(downloadBtn);
        });
    }

    async function export_sql() {
        // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á export_sql.php ‡∏î‡πâ‡∏ß‡∏¢ Fetch API
        fetch('../config/sql_export.php', {
            method: 'POST',  // ‡πÉ‡∏ä‡πâ method POST
            headers: {
                'Content-Type': 'application/json'
            },
            // ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô body ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏™‡πà‡πÑ‡∏î‡πâ
            // body: JSON.stringify({ key: "value" })
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotify('‚úÖ Export database file success.');
                } else {
                    showNotify('‚ùå Export database file failed. Please check: ' + data.message);
                    console.error(data.message); // log error ‡πÄ‡∏û‡∏¥‡πà‡∏°
                }
            })
            .catch(error => {
                showNotify('‚ùó ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ server');
                console.error('Fetch error:', error);
            });
        await generate_table();
    }

    async function import_sql(event) {
        let fileInput = event.target;  // ‡πÑ‡∏î‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å input
        let formData = new FormData();

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏´‡∏°
        if (fileInput.files.length === 0) {
            showNotify('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô (‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• .sql ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)');
            return;
        }

        formData.append('sqlFile', fileInput.files[0]);

        // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á import_sql.php
        fetch('../config/import_sql.php', {
            method: 'POST',
            body: formData
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    showNotify('‚úÖ Import database file success.');
                } else {
                    showNotify('‚ùå Import database file failed. Please check: ' + data.message);
                }
            })
            .catch(error => {
                showNotify('‚ùó ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ server');
                console.error('Fetch error:', error);
            });
    }

    function click_import() {
        document.getElementById('sqlInput').click();
    }
</script>